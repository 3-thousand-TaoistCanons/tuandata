<?php use \Tuanduimao\Loader\App as App; ?>
<div class="block-content">
    <form id="TAB_14671164784783490_FORM" 
          class="js-validation-TAB_14671164784783490_FORM form-horizontal" 
          action="<?=App::NR('Datatype','appDataSave',['action'=>'app'])?>" method="post" >

		<input type="hidden" name="_model" value="Datatype" />
		<input type="hidden" class="updateflag" name="id" value="<?=$inst['_id']?>" />
		<input type="hidden" class="updateflag" name="tid" value="<?=$inst['typeid']?>" />
	
		<!-- FORM GROUP GROUP_14671167039232431 -->
		<div class="form-group">

			<!-- 应用名称  组件单行文本 (inlinetext)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
			      	<input 	id="ID_146711670392350" name="appcname" 
			      			type="text"  	
			 
							class="form-control"  placeholder="请填写应用名称"  
							value="<?=(isset($inst['appcname'])) ? $inst['appcname'] : '' ?>"
							 />
			
			      	<label class="title" for="appcname">应用名称</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 应用名称  组件单行文本 (inlinetext)-->
		
		</div> <!-- END FORM GROUP GROUP_14671167039232431 -->

		<!-- FORM GROUP GROUP_14671168227204001 -->
		<div class="form-group">

			<!-- 应用图标  图片上传 (imageuploader)-->
			<div class="col-lg-12 col-md-12 col-xs-12  "> 
				<label for="appicon">应用图标</label>
			 	<div class="form-material">
					<div 	id="ID_14671168227207744" name="appicon"
			        		class="file-uploader rounded rounded-4"
			            	data-api="<?=App::NR('uploader.php','index');?>"
			            	data-previews="90|50,50|50,50,p50" 
			            	data-title='上传图片'
			            	data-width="150px"
			            	data-height="150px"
			            	data-icon="fa fa-image" 
			            	data-placeholder="点击或拖入图片" 
			            	data-allow-types="image/png,image/jpg,image/jpeg"
			            	data-maxsize="2"
			            	data-progress="yes"
			            	data-draggable="yes"
			            	data-src="<?=(isset($inst['appicon_url'])) ? $inst['appicon_url'] : '' ?>"
			            	data-path="<?=(isset($inst['appicon_path'])) ? $inst['appicon_path'] : '' ?>"
			            	></div>
			 	</div>
			      <div class="help-block text-right"></div>
			</div><!-- END 应用图标  图片上传 (imageuploader)-->
			
		
		</div> <!-- END FORM GROUP GROUP_14671168227204001 -->

		<!-- FORM GROUP GROUP_14671167722958443 -->
		<div class="form-group">

			<!-- 应用简介  组件多行文本 (multilinetext)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
			      	<textarea 	
			      		id="ID_14671167722959216" name="appdesp" rows="4"
			      		class="form-control  "
						placeholder="请填写应用简介"  
					><?=(isset($inst['appdesp'])) ? $inst['appdesp'] : '' ?></textarea>
			      	<label class="title" for="appdesp">应用简介</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 应用简介  组件多行文本 (multilinetext)-->
		
		</div> <!-- END FORM GROUP GROUP_14671167722958443 -->

		<!-- FORM GROUP GROUP_14671169695501278 -->
		<div class="form-group">

			<!-- 移动平台  多选 (checkbox)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
					<div>
			
					   <label class="css-input css-checkbox css-checkbox-primary push-10-r  ">
					        <input 
					        	type="checkbox" 
					        	id="ID_14671169695501262_0" 
					        	name="mplat"  value="选项一"
					        	<?=($inst['mplat']=='选项一') ? 'checked' : '' ?>    
								<?=(!isset($inst['mplat'])) ? 'checked' : '' ?> 
					        ><span></span> 选项一		   </label>
			
			
					   <label class="css-input css-checkbox css-checkbox-primary push-10-r  ">
					        <input 
					        	type="checkbox" 
					        	id="ID_14671169695501262_1" 
					        	name="mplat"  value="选项二"
					        	<?=($inst['mplat']=='选项二') ? 'checked' : '' ?>    
								<?=(!isset($inst['mplat'])) ? '' : '' ?> 
					        ><span></span> 选项二		   </label>
			
			
					   <label class="css-input css-checkbox css-checkbox-primary push-10-r  ">
					        <input 
					        	type="checkbox" 
					        	id="ID_14671169695501262_2" 
					        	name="mplat"  value="选项三"
					        	<?=($inst['mplat']=='选项三') ? 'checked' : '' ?>    
								<?=(!isset($inst['mplat'])) ? '' : '' ?> 
					        ><span></span> 选项三		   </label>
			
					</div>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 移动平台 多选 (checkbox)-->
		
		</div> <!-- END FORM GROUP GROUP_14671169695501278 -->

		<!-- FORM GROUP GROUP_14671170672578531 -->
		<div class="form-group">

			<!--   按钮组 (btngroup)-->
			<div class="col-lg-12">
			
				<div class="form-material text-left">
					<button  
						id="ID_14671170672571327_0" 
						name="ID_14671170672571327_0"  
						type="submit" 
						class="btn btn-primary font-w300  push-20-r create update"  
						 
					>
			            <i class="fa fa-save push-5-r"></i> 
						保存设置 
					</button>
					<button  
						id="ID_14671170672571327_1" 
						name="ID_14671170672571327_1"  
						type="button" 
						class="btn btn-danger font-w300 pull-right  push-20-r create update"  
						 
					>
			            <i class="fa fa-refresh push-5-r"></i> 
						更新应用 
					</button>
				</div>
			
			</div><!-- END 按钮组  按钮组 (btngroup)-->
			
		
		</div> <!-- END FORM GROUP GROUP_14671170672578531 -->


	</form>
</div>


<script type="text/javascript">


/**
 * 提交表单 
 * @param {[type]} validation [description]
 * @param {[type]} form       [description]
 */
function TAB_14671164784783490_FORM_DataSubmit( validation, form  ) {

	var replace = function( keys, string ) {
		if ( typeof string != 'string' ) {
			return string;
		}

		keys = keys || [];
		for( var name in keys ) {
			var value = keys[name];
			var reg = new RegExp("\\{_" + name + "\\}", "g");
			// console.log(reg, name, value);
			string = string.replace(reg, value);
			// console.log(string);
		}

		return string;
	}


	var isUpdate = false;
    var api = $(form).attr('action');
    var next = $(form).attr('data-next');
    var submits = $('button', form);
        $(submits).attr('disabled', 'disabled');
        $(submits).addClass('disabled');

    var data = {};

    var formData =  $(form).serializeArray();
        for( var i=0; i<formData.length; i++ ) {
            var name = formData[i]['name'];
            var value = formData[i]['value'];

            if (value !== "") {
                data[name] = value;
            }
        }


    data = jQuery.extend(data, {});

    $.post( api, data, function(data, textStatus, xhr) {

        $(submits).removeAttr('disabled');
        $(submits).removeClass('disabled');

        code = data['code'] || 0;
        extra = data['extra'] || [];

		if ($('input[name="id"]').val() !== "" ) {
			isUpdate = true;
		}
		if ( typeof data['_id'] != 'undefined') {
			$('input[name="id"]').val(data['_id']);
		}
		if ($('input[name="tid"]').val() !== "" ) {
			isUpdate = true;
		}
		if ( typeof data['typeid'] != 'undefined') {
			$('input[name="tid"]').val(data['typeid']);
		}


        if ( typeof extra == 'object' && isNaN(extra.length) ) {
            extra = [extra];
        }



        if ( parseInt(code) == 302 ) {
            window.location.reload(true);
            return;
        }


        if ( typeof data['result'] == 'boolean' && typeof data['content'] == 'string' ) {
            
            if (  data['result'] === false ) {
                code = -1;
                extra[0] = {
                    '_FIELD':'error',
                    'message':data['content']
                };
            }
        }


        if ( code != 0 ) {

            for( i=0; i<extra.length; i++ ) {
                field = extra[i]['_FIELD'] || null;
                if ( field != null ) {
                    message = data['message'] || '出错啦';
                    if ( typeof extra[i]['message'] != 'undefined' ) {
                        message = extra[i]['message'];
                    }
                    var err = {};
                        err[field] = message;

                    validation.showErrors(err);
                }

				message = '创建失败';
		        if ( isUpdate ) {
		        	message = '更新失败';
		        }
   
                App.notify( replace(data,message), 'fa fa-times','danger');
            }

            return;
        }

        message = '创建成功';
        if ( isUpdate ) {
        	message = '更新成功';
            TAB_14671164784783490_FORM_updateShow(data);
        }

        // 全局通知
        App.notify( replace(data,message)  );
        
        return;

    },'json')

    .error( function(xhr, status, statusText ){

		if ($('input[name="id"]').val() !== "" ) {
			isUpdate = true;
		}
		if ($('input[name="tid"]').val() !== "" ) {
			isUpdate = true;
		}

		message = '创建失败';
		if ( isUpdate ) {
			message = '更新失败';
		}

        validation.showErrors({'error': statusText.toString()} );
             $(submits).removeAttr('disabled');
             $(submits).removeClass('disabled');
        App.notify(replace({message:statusText.toString()},message), 'fa fa-times','danger');

        return;
    });
}




/**
 * 表单验证
 */
var TAB_14671164784783490_FORM = function() {
    var initValidation = function(){
        jQuery('.js-validation-TAB_14671164784783490_FORM').validate({
            errorClass: 'help-block text-right animated fadeInDown',
            errorElement: 'div',
            errorPlacement: function(error, e) {                
                jQuery(e).parents('.form-group .form-material').append(error);
            },
            highlight: function(e) {
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error').addClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },
            unhighlight:function(e){
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },
            success: function(e) {
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },

            submitHandler: function(form) {
                var self = this;
                TAB_14671164784783490_FORM_DataSubmit( self, form );
            },
            rules: {
                "appcname": {
                    required: true,
                    minlength: 2,
                    maxlength: 10,
                },
                "appdesp": {
                    minlength: 4,
                    maxlength: 50,
                },
            },

            messages: {
                "appcname": {
                    required: "请填写应用名称",
                    minlength: "应用名称不能少于2个字",
                    maxlength: "应用名称不能超过10个字",
                },
                "appdesp": {
                    minlength: "应用简介不能少于4个字",
                    maxlength: "应用简介不能超过50个字",
                },
            }
        });
    };

    return {
        init: function () {
            initValidation();  // Init Form Validation

            if ( TAB_14671164784783490_FORM_isUpdate() === true ) {
                TAB_14671164784783490_FORM_updateShow(<?=json_encode($inst)?>);
            } else {
                TAB_14671164784783490_FORM_createShow();
            }
        }
    };
}();

/**
 * 判断当前页面为更新还是保存
 * @return {[type]} [description]
 */
function TAB_14671164784783490_FORM_isUpdate() {
    var isupdate = false;
    $('.updateflag', '.js-validation-TAB_14671164784783490_FORM').each(function(idx,elm){
        if ( $(elm).val() != '') {
             isupdate = true;
        }
    })
    return isupdate;
}


/**
 * 显示更新操作按钮
 * @return {[type]} [description]
 */
function TAB_14671164784783490_FORM_updateShow( data ) {
    var createShow = $('button.create:not(.update)', '.js-validation-TAB_14671164784783490_FORM');
    var updateShow = $('button.update:not(.create)', '.js-validation-TAB_14671164784783490_FORM');
    createShow.hide();
    updateShow.show();
    TAB_14671164784783490_FORM_tabName( "移动应用", data );
}


/**
 * 显示新建操作按钮
 * @return {[type]} [description]
 */
function TAB_14671164784783490_FORM_createShow() {
    var createShow = $('button.create:not(.update)', '.js-validation-TAB_14671164784783490_FORM');
    var updateShow = $('button.update:not(.create)', '.js-validation-TAB_14671164784783490_FORM');
    createShow.show();
    updateShow.hide();
    TAB_14671164784783490_FORM_tabName( "移动应用" );
}


function TAB_14671164784783490_FORM_tabName( name, data ) {
    data = data || null;
    if ( typeof data == 'object' ) {
        for( key in data ) {
            var reg = new RegExp('\{' + key.toUpperCase() + '\}', 'gi');
            name =  name.replace(reg, data[key]);
        }
    }
    $('#TAB_14671164784783490').children('span').html(name);
}


</script>


<script type="text/javascript">
$(function () {

    // 表单验证程序 初始化
    TAB_14671164784783490_FORM.init();

	// 初始化 appicon (#ID_14671168227207744) ImageUploader
	try{ 
		App.initHelpers('file-uploader', {
	    	'home':'<?=\Tuanduimao\Conf::G("storage/local/bucket/public/home")?>',
	    	'handler':'#ID_14671168227207744'
		});
	}catch(e){
		console.log('ImageUploader(appicon)  Error:',  e);
	}
	
	App.initHelpers('image-crop');
	

});
</script>


