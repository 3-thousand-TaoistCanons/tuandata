<?php use \Tuanduimao\Loader\App as App;
use \Tuanduimao\Utils as Utils;
$ut = new Utils; ?>
<div class="block-content">
    <form id="TAB_14671151760376891_FORM" 
          class="js-validation-TAB_14671151760376891_FORM form-horizontal" 
          action="<?=App::NR('Datatype','generalDataSave',['action'=>'general'])?>" method="post" >

		<input type="hidden" name="_model" value="Datatype" />
		<input type="hidden" class="updateflag" name="id" value="<?=$inst['_id']?>" />
		<input type="hidden" class="updateflag" name="tid" value="<?=$inst['typeid']?>" />
	
		<!-- FORM GROUP GROUP_14671152294796759 -->
		<div class="form-group">

			<!-- 中文名称  组件单行文本 (inlinetext)-->
			<div class="col-lg-6 col-md-6 col-xs-6"> 
			 	<div class="form-material">
			      	<input 	id="ID_14671152294797576" name="cname" 
			      			type="text"  	
			 
							class="form-control"  placeholder="请填写类型名称"  
							value="<?=(isset($inst['cname'])) ? $inst['cname'] : '' ?>"
							 />
			
			      	<label class="title" for="cname">中文名称</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 中文名称  组件单行文本 (inlinetext)-->


			<!-- 英文名称  组件单行文本 (inlinetext)-->
			<div class="col-lg-6 col-md-6 col-xs-6"> 
			 	<div class="form-material">
			      	<input 	id="ID_1467115609731943" name="name" 
			      			type="text"  	
			 
							class="form-control"  placeholder="请填写英文名称"  
							value="<?=(isset($inst['name'])) ? $inst['name'] : '' ?>"
							 />
			
			      	<label class="title" for="name">英文名称</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 英文名称  组件单行文本 (inlinetext)-->
		
		</div> <!-- END FORM GROUP GROUP_14671152294796759 -->

		<!-- FORM GROUP GROUP_14671157420735964 -->
		<div class="form-group">

			<!-- 字段清单  组件多选清单 (multiselector)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
					<select multiple class="searchable" name="fields[]">
                        <?php foreach($host['fields'] as $field ) : 
                            $randval = mt_rand(0,1000);
                            $selected = (in_array($field['uuid'],$fields) ) ? 'selected' : '';
                        ?>
                        <option 
                           data-icon="<?=$field['icon']?>"
                           value="<?=$field['uuid']?>"  <?=$selected?> > 
                            <?=$field['screen_name']?>
                        </option>
                        <?php endforeach;?>
                    </select>
			      	<label class="title" for="fields">选择字段</label>
			      	<div class="help-block text-right">请从左侧字段库中选择资料所需字段</div>
			 	</div>
			</div><!-- END 字段清单  组件多行文本 (multilinetext)-->
		
		</div> <!-- END FORM GROUP GROUP_14671157420735964 -->

		<!-- FORM GROUP GROUP_14671158722213713 -->
		<div class="form-group">

			<!-- 绑定域名  组件单行文本 (inlinetext)-->
			<div class="col-lg-6 col-md-6 col-xs-6"> 
			 	<div class="form-material">
			      	<input 	id="ID_14671158722211994" name="domain" 
			      			type="text"  	
			 
							class="form-control"  placeholder="请填写访问域名"  
							value="<?=(isset($inst['domain'])) ? $inst['domain'] : '' ?>"
							 />
			
			      	<label class="title" for="domain">绑定域名</label>
			      	<div class="help-block text-right">建议域名解析生效后填写</div>
			 	</div>
			</div><!-- END 绑定域名  组件单行文本 (inlinetext)-->


			<!-- 前端服务器IP  组件单行文本 (inlinetext)-->
			<div class="col-lg-6 col-md-6 col-xs-6"> 
			 	<div class="form-material">
			      	<input 	id="ID_14671159589237747" name="ID_14671159589237747" 
			      			type="text"  disabled 
				
							class="form-control disabled>"  placeholder=""  
							value="<?=$ut->getServerIP()?>"
							 />
			
			      	<label class="title" for="ID_14671159589237747">前端服务器IP</label>
			      	<div class="help-block text-right">请将已备案域名解析到此IP地址</div>
			 	</div>
			</div><!-- END 前端服务器IP  组件单行文本 (inlinetext)-->
		
		</div> <!-- END FORM GROUP GROUP_14671158722213713 -->

		<!-- FORM GROUP GROUP_14671160420141102 -->
		<div class="form-group">

			<!-- 路由设置  组件多行文本 (multilinetext)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
			      	<textarea 	
			      		id="ID_1467116042014668" name="route" rows="4"
			      		class="form-control  "
						placeholder="请填写路由映射规则"  
					><?=(isset($inst['route'])) ? $inst['route'] : '' ?></textarea>
			      	<label class="title" for="route">路由设置</label>
			      	<div class="help-block text-right">每行一条规则 ( 地址正则&lt;sp&gt; 匹配地址&lt;sp&gt; 优先级&lt;sp&gt; 缓存时间(秒)&lt;sp&gt; 反解控制器&lt;sp&gt; 反解地址)</div>
			 	</div>
			</div><!-- END 路由设置  组件多行文本 (multilinetext)-->
		
		</div> <!-- END FORM GROUP GROUP_14671160420141102 -->

		<!-- FORM GROUP GROUP_14671162108074116 -->
		<div class="form-group">

			<!-- 默认阅读权限  标签 (tagsinput)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
			      	
					<select 
				      	id="ID_14671162108074462" name="readable[]"
				      	class="js-select2 form-control" 
				      	style="width: 100%;" placeholder="" multiple > 

			            <option></option><!-- Required for data-placeholder attribute to work with Select2 plugin -->
						<option value="boss" 
							<?=(isset($inst['readable']) && in_array('boss', $inst['readable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['readable'])) ? 'selected' : '' ?>
						>企业主</option>
						<option value="admin" 
							<?=(isset($inst['readable']) && in_array('admin', $inst['readable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['readable'])) ? 'selected' : '' ?>
						>管理员</option>
						<option value="manager" 
							<?=(isset($inst['readable']) && in_array('manager', $inst['readable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['readable'])) ? 'selected' : '' ?>
						>主管</option>
						<option value="user" 
							<?=(isset($inst['readable']) && in_array('user', $inst['readable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['readable'])) ? 'selected' : '' ?>
						>员工</option>
						<option value="vistor" 
							<?=(isset($inst['readable']) && $inst['readable']=='vistor') ? 'selected' : '' ?>    
							<?=(!isset($inst['readable'])) ? 'selected' : '' ?>
						>访客</option>
			        </select>

			      	<label class="title" for="readable">默认阅读权限</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 默认阅读权限  标签 (tagsinput)-->
		
		</div> <!-- END FORM GROUP GROUP_14671162108074116 -->

		<!-- FORM GROUP GROUP_14671163540413515 -->
		<div class="form-group">

			<!-- 默认创建权限  标签 (tagsinput)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
					<select 
				      	id="ID_14671163540415202" name="createable[]"
				      	class="js-select2 form-control" 
				      	style="width: 100%;" placeholder="" multiple > 

			            <option></option><!-- Required for data-placeholder attribute to work with Select2 plugin -->
						<option value="boss" 
							<?=(isset($inst['createable']) && in_array('boss', $inst['createable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['createable'])) ? 'selected' : '' ?>
						>企业主</option>
						<option value="admin" 
							<?=(isset($inst['createable']) && in_array('admin', $inst['createable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['createable'])) ? 'selected' : '' ?>
						>管理员</option>
						<option value="manager" 
							<?=(isset($inst['createable']) && in_array('manager', $inst['createable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['createable'])) ? 'selected' : '' ?>
						>主管</option>
						<option value="user" 
							<?=(isset($inst['createable']) && in_array('user', $inst['createable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['createable'])) ? 'selected' : '' ?>
						>员工</option>
						<option value="vistor" 
							<?=(isset($inst['createable']) && $inst['createable']=='vistor') ? 'selected' : '' ?>    
							<?=(!isset($inst['createable'])) ? '' : '' ?>
						>访客</option>
			        </select>
			      	<label class="title" for="createable">默认创建权限</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 默认创建权限  标签 (tagsinput)-->
		
		</div> <!-- END FORM GROUP GROUP_14671163540413515 -->

		<!-- FORM GROUP GROUP_14671162893758718 -->
		<div class="form-group">

			<!-- 默认修改权限  标签 (tagsinput)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
					<select 
				      	id="ID_14671162893754335" name="writeable[]"
				      	class="js-select2 form-control" 
				      	style="width: 100%;" placeholder="" multiple > 

			            <option></option><!-- Required for data-placeholder attribute to work with Select2 plugin -->
						<option value="boss" 
							<?=(isset($inst['writeable']) && in_array('boss', $inst['writeable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['writeable'])) ? 'selected' : '' ?>
						>企业主</option>
						<option value="admin" 
							<?=(isset($inst['writeable']) && in_array('admin', $inst['writeable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['writeable'])) ? 'selected' : '' ?>
						>管理员</option>
						<option value="manager" 
							<?=(isset($inst['writeable']) && in_array('manager', $inst['writeable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['writeable'])) ? 'selected' : '' ?>
						>主管</option>
						<option value="user" 
							<?=(isset($inst['writeable']) && in_array('user', $inst['writeable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['writeable'])) ? 'selected' : '' ?>
						>员工</option>
						<option value="vistor" 
							<?=(isset($inst['writeable']) && $inst['writeable']=='vistor') ? 'selected' : '' ?>    
							<?=(!isset($inst['writeable'])) ? '' : '' ?>
						>访客</option>
			        </select>
			      	<label class="title" for="writeable">默认修改权限</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 默认修改权限  标签 (tagsinput)-->
		
		</div> <!-- END FORM GROUP GROUP_14671162893758718 -->

		<!-- FORM GROUP GROUP_14671163886113982 -->
		<div class="form-group">

			<!-- 默认删除权限  标签 (tagsinput)-->
			<div class="col-lg-12 col-md-12 col-xs-12"> 
			 	<div class="form-material">
					<select 
				      	id="ID_14671163886114009" name="deleteable[]"
				      	class="js-select2 form-control" 
				      	style="width: 100%;" placeholder="" multiple > 

			            <option></option><!-- Required for data-placeholder attribute to work with Select2 plugin -->
						<option value="boss" 
							<?=(isset($inst['deleteable']) && in_array('boss', $inst['deleteable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['deleteable'])) ? 'selected' : '' ?>
						>企业主</option>
						<option value="admin" 
							<?=(isset($inst['deleteable']) && in_array('admin', $inst['deleteable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['deleteable'])) ? 'selected' : '' ?>
						>管理员</option>
						<option value="manager" 
							<?=(isset($inst['deleteable']) && in_array('manager', $inst['deleteable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['deleteable'])) ? 'selected' : '' ?>
						>主管</option>
						<option value="user" 
							<?=(isset($inst['deleteable']) && in_array('user', $inst['deleteable'])) ? 'selected' : '' ?>    
							<?=(!isset($inst['deleteable'])) ? 'selected' : '' ?>
						>员工</option>
						<option value="vistor" 
							<?=(isset($inst['deleteable']) && $inst['deleteable']=='vistor') ? 'selected' : '' ?>    
							<?=(!isset($inst['deleteable'])) ? '' : '' ?>
						>访客</option>
			        </select>
			      	<label class="title" for="deleteable">默认删除权限</label>
			      	<div class="help-block text-right"></div>
			 	</div>
			</div><!-- END 默认删除权限  标签 (tagsinput)-->
		
		</div> <!-- END FORM GROUP GROUP_14671163886113982 -->

		<!-- FORM GROUP GROUP_14671172870081144 -->
		<div class="form-group">

			<!--   按钮组 (btngroup)-->
			<div class="col-lg-12">
			
				<div class="form-material text-left">
					<button  
						id="ID_14671172870094912_0" 
						type="submit" 
						class="btn btn-primary font-w300  push-20-r create"
					>
			            <i class="fa fa-plus push-5-r"></i> 
						创建类型 
					</button>
					<button  
						id="ID_14671172870094912_1" 
						type="submit" 
						class="btn btn-primary font-w300  push-20-r update"  
					>
			            <i class="fa fa-save push-5-r"></i> 
						更新类型 
					</button>
				</div>
			
			</div><!-- END   按钮组 (btngroup)-->
			
		
		</div> <!-- END FORM GROUP GROUP_14671172870081144 -->


	</form>
</div>


<script type="text/javascript">


/**
 * 提交表单 
 * @param {[type]} validation [description]
 * @param {[type]} form       [description]
 */
function TAB_14671151760376891_FORM_DataSubmit( validation, form, callback, option  ) {

	if ( typeof callback != 'function' ) {
		callback = function(data, status, xhr) { console.log('=========\n', 'submit callback:\n', status, data, '\n=========\n');  }	
	}

	option = option || {}
	option['mute'] = option['mute'] || false;

	var replace = function( keys, string ) {
		if ( typeof string != 'string' ) {
			return string;
		}

		keys = keys || [];
		for( var name in keys ) {
			var value = keys[name];
			var reg = new RegExp("\\{_" + name + "\\}", "g");
			// console.log(reg, name, value);
			string = string.replace(reg, value);
			// console.log(string);
		}

		return string;
	}


	var isUpdate = false;
    var api = $(form).attr('action');
    var next = $(form).attr('data-next');
    var submits = $('button', form);
        $(submits).attr('disabled', 'disabled');
        $(submits).addClass('disabled');

    var data = {};
    var formData =  $(form).serializeArray();
        for( var i=0; i<formData.length; i++ ) {
            var name = formData[i]['name'];
            var value = formData[i]['value'];
            if ( value !== null ) {
            	var arrflag = name.indexOf('[]');
            	if ( arrflag > 0 ) {
            		name = name.substr(0, arrflag);
            		if ( typeof data[name] == 'undefined' ) {
            			data[name] = [];
            		}
            	}
                if ( typeof data[name] == 'undefined' ) {
                	data[name] = value;
                } else if ( typeof data[name] == 'string' ) {
                	data[name] = [data[name], value];
                } else if ( $.isArray(data[name]) ) {
                	data[name].push(value);
                }
            }
        }

    data = jQuery.extend(data, {});
    $.post( api, data, function(data, textStatus, xhr) {

        $(submits).removeAttr('disabled');
        $(submits).removeClass('disabled');

        code = data['code'] || 0;
        extra = data['extra'] || [];

		if ($('input[name="id"]').val() !== "" ) {
			isUpdate = true;
		}
		if ( typeof data['_id'] != 'undefined') {
			$('input[name="id"]').val(data['_id']);
		}
		if ($('input[name="tid"]').val() !== "" ) {
			isUpdate = true;
		}
		if ( typeof data['typeid'] != 'undefined') {
			$('input[name="tid"]').val(data['typeid']);
		}


        if ( typeof extra == 'object' && isNaN(extra.length) ) {
            extra = [extra];
        }



        if ( parseInt(code) == 302 ) {
        	callback( data, 'success', xhr );
            window.location.reload(true);
            return;
        }


        if ( typeof data['result'] == 'boolean' && typeof data['content'] == 'string' ) {
            
            if (  data['result'] === false ) {
                code = -1;
                extra[0] = {
                    '_FIELD':'error',
                    'message':data['content']
                };
            }
        }


        if ( code != 0 ) {

            for( i=0; i<extra.length; i++ ) {
                field = extra[i]['_FIELD'] || null;
                if ( field != null ) {
                    message = data['message'] || '出错啦';
                    if ( typeof extra[i]['message'] != 'undefined' ) {
                        message = extra[i]['message'];
                    }
                    var err = {};
                        err[field] = message;

                    validation.showErrors(err);
                }

				message = '创建失败';
		        if ( isUpdate ) {
		        	message = '更新失败';
		        }
   				

                App.notify( replace(data,message), 'fa fa-times','danger');
            }

            callback( data, 'error', xhr );
            return;
        }

        message = '创建成功';
        if ( isUpdate ) {
        	message = '更新成功';
        }

        TAB_14671151760376891_FORM_updateShow(data);

        // 全局通知
        if ( !option['mute'] ) {
        	App.notify( replace(data,message)  );
        }
        callback( data, 'success', xhr );
        return;

    },'json')

    .error( function(xhr, status, statusText ){

		if ($('input[name="id"]').val() !== "" ) {
			isUpdate = true;
		}
		if ($('input[name="tid"]').val() !== "" ) {
			isUpdate = true;
		}

		message = '创建失败';
		if ( isUpdate ) {
			message = '更新失败';
		}

        validation.showErrors({'error': statusText.toString()} );
             $(submits).removeAttr('disabled');
             $(submits).removeClass('disabled');
        App.notify(replace({message:statusText.toString()},message), 'fa fa-times','danger');
        callback( {'error': statusText.toString()}, 'error', xhr );
        return;
    });
}




/**
 * 表单验证
 */
var TAB_14671151760376891_FORM = function() {
    var initValidation = function(){
        return jQuery('.js-validation-TAB_14671151760376891_FORM').validate({
            errorClass: 'help-block text-right animated fadeInDown',
            errorElement: 'div',
            errorPlacement: function(error, e) {                
                jQuery(e).parents('.form-group .form-material').append(error);
            },
            highlight: function(e) {
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error').addClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },
            unhighlight:function(e){
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },
            success: function(e) {
                jQuery(e).closest('.form-group .form-material').parent().removeClass('has-error');
                jQuery(e).closest('.help-block').remove();
            },

            submitHandler: function(form) {
                var self = this;
                TAB_14671151760376891_FORM_DataSubmit( self, form );
            },
            rules: {
                "cname": {
                    required: true,
                    minlength: 2,
                    maxlength: 20,
                },
                "name": {
                    required: true,
                },
            },

            messages: {
                "cname": {
                    required: "请填写中文名称",
                    minlength: "中文名称不能少于2个字",
                    maxlength: "中文名称不能超过20个字",
                },
                "name": {
                    required: "请填写英文名称",
                },
            }
        });
    };

    return {
        init: function () {
            var validationObject = initValidation();  // Init Form Validation

            if ( TAB_14671151760376891_FORM_isUpdate() === true ) {
                TAB_14671151760376891_FORM_updateShow(<?=json_encode($inst)?>);
            } else {
                TAB_14671151760376891_FORM_createShow();
            }

            return validationObject;
        }
    };
}();

/**
 * 判断当前页面为更新还是保存
 * @return {[type]} [description]
 */
function TAB_14671151760376891_FORM_isUpdate() {
    var isupdate = false;
    $('.updateflag', '.js-validation-TAB_14671151760376891_FORM').each(function(idx,elm){
        if ( $(elm).val() != '') {
             isupdate = true;
        }
    })
    return isupdate;
}


/**
 * 显示更新操作按钮
 * @return {[type]} [description]
 */
function TAB_14671151760376891_FORM_updateShow( data ) {
    var createShow = $('button.create:not(.update)', '.js-validation-TAB_14671151760376891_FORM');
    var updateShow = $('button.update:not(.create)', '.js-validation-TAB_14671151760376891_FORM');
    createShow.hide();
    updateShow.show();
    TAB_14671151760376891_FORM_tabName( "基本信息", data );

    var tab = $('#tabforms-h5_datatype').tabGet('tabs-general');
    	if ( tab !== false ){
    		tab.attr('confirm-display', 'false');
    	}

    var tid = data['typeid'] || null;
    var id = data['_id'] || null;

    // 更新链接
    $('#tabforms-h5_datatype').tabRemoteEach(function(url, tab) {
    	if ( tid != null ) {
    		var reg = new RegExp("tid=([0-9a-zA-Z\.]*)", "g");
			url = url.replace(reg, 'tid='+tid);
			$(tab).attr('data-remote', url);
    	} 
    });
}


/**
 * 显示新建操作按钮
 * @return {[type]} [description]
 */
function TAB_14671151760376891_FORM_createShow() {
    var createShow = $('button.create:not(.update)', '.js-validation-TAB_14671151760376891_FORM');
    var updateShow = $('button.update:not(.create)', '.js-validation-TAB_14671151760376891_FORM');
    createShow.show();
    updateShow.hide();
    TAB_14671151760376891_FORM_tabName( "基本信息" );
}


function TAB_14671151760376891_FORM_tabName( name, data ) {
    data = data || null;
    if ( typeof data == 'object' ) {
        for( key in data ) {
            var reg = new RegExp('\{' + key.toUpperCase() + '\}', 'gi');
            name =  name.replace(reg, data[key]);
        }
    }
    $('#TAB_14671151760376891').children('span').html(name);
}


</script>


<script type="text/javascript">
$(function () {

    // 表单验证程序 初始化
    var validationObject = TAB_14671151760376891_FORM.init();

    // Select2 
    App.initHelpers(['select2']);


    // 资料类型名称 实时更新
    $('input[name=cname]', '.js-validation-TAB_14671151760376891_FORM').keyup(function(event) {
    	var cname = $(this).val();
    	if ( cname == '' ) {
    		cname = ' &lt; 未命名资料库  &gt; ';
    	}
    	$('li.active.current-datatype span', '#block-h5_datatype').html( cname );
    });

    // General 切换时候，提醒用户保存
    $('#tabforms-h5_datatype').tabLeave('tabs-general', function(tab, pane, leavedef ) {

    	var resp = $('.js-validation-TAB_14671151760376891_FORM').valid();
    	if ( resp === false ) {
    		leavedef.reject();
    	} else {
	        TAB_14671151760376891_FORM_DataSubmit( validationObject, $('.js-validation-TAB_14671151760376891_FORM'), function(data, status, xhr){
	        	if ( status == 'success') {
	        		 var tab = $('#tabforms-h5_datatype').tabGet('tabs-general');
	        			leavedef.resolve();
	        	} else {
	        		leavedef.reject();
	        	}
	        }, {'mute':true}); 
        }
   
        return leavedef;
    });


	
	// 初始化 字段选择器 (#ID_14671163886114009) multiSelect
    $('.searchable', '.js-validation-TAB_14671151760376891_FORM').multiSelect({
      sortable: true,
      selectableHeader: "<div class='row '>"
                       +"	<div class='col-lg-6'><input type='text' class='form-control font-w300 search-input  push-15 push-10-t'  autocomplete='off' placeholder='关键词'> </div>" 
                       +"	<div class='col-lg-6'>"
                       +'		<select class="js-select2 form-control push-15 push-10-t" id="fieldSelector" name="fieldSelector" style="width:100%;">'
                       <?php foreach ($hosts as $idx=>$host ) : ?>
                       +'   		<option value="<?=$idx?>"><?=$host['name']?></option>'
                       <?php endforeach; ?>
                       +'		</select>'
                       +"	</div>"
      				   +"</div>",

      selectionHeader: "<input type='text' class='form-control font-w300 search-input push-15 push-10-t' autocomplete='off' placeholder='关键词'>",
      afterInit: function(ms){
        var that = this,
            $selectableSearch = that.$selectableUl.prev().find('input'),
            $selectionSearch = that.$selectionUl.prev(),
            selectableSearchString = '#'+that.$container.attr('id')+' .ms-elem-selectable:not(.ms-selected)',
            selectionSearchString = '#'+that.$container.attr('id')+' .ms-elem-selection.ms-selected';

        // console.log(that.$selectableUl.prev());
        // console.log(that.$selectionUl.prev());

        that.qs1 = $selectableSearch.quicksearch(selectableSearchString)
        .on('keydown', function(e){
          if (e.which === 40){
            that.$selectableUl.focus();
            return false;
          }
        });

        that.qs2 = $selectionSearch.quicksearch(selectionSearchString)
        .on('keydown', function(e){
          if (e.which == 40){
            that.$selectionUl.focus();
            return false;
          }
        });


        // 设置Select更新事件
        $('#fieldSelector').on('change', function (evt) {
		  	var url = '<?=APP::NR('datatype','getfield',['hid'=>''])?>' + $(this).val();
		  	var current = $(this).val();
		  	$.get(url, function(data){

		  		if( !$.isArray(data['fields']) ) {
		  			return;
		  		}

		  		// 已选中字段列表
		  		var selected = $('.searchable').val();

		  		// 移除非选中字段
		  		$('option', '.searchable').each( function(idx,opt ) {
		  			if ( $.inArray( $(opt).attr('value'), selected ) < 0  ) {
		  				$(opt).remove();
		  			}
		  		});

		  		// 载入字段服务器中字段清单
		  		for( var i=0; i<data['fields'].length; i++ ) {

		  			var field = data['fields'][i];
		  			var text = field['screen_name'];
		  			var value = field['uuid'];

		  			if ( $.inArray( value, selected ) < 0  ) {
			  			var opt = $('<option></option>');		  			
			  			opt.html(' ' +text +' ');
			  			opt.attr('value', value);
			  			if ( typeof field['icon'] == 'string') {			  				
			  				opt.attr('data-icon', field['icon']);
			  			}
			  			opt.appendTo('.searchable');
		  			}
		  		}

		  		$('.searchable').multiSelect('refresh');

		  		// 保持选中状态
		  		$('#fieldSelector').val(current);
		  		$('#fieldSelector').trigger('change.selected');

		  	})
		  	.error(function(error){
		  		console.log(error);
		  	});
		});

      },

      afterSelect: function(){
        this.qs1.cache();
        this.qs2.cache();
      },
      afterDeselect: function(){
        this.qs1.cache();
        this.qs2.cache();
      }
    });


});
</script>


